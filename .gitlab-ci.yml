frontend:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - webserver/*
      when: always
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: never
    - if: $CI_COMMIT_TAG
      when: never
  tags: local_runner
  script:
    - echo frontend

  cache: &global_cache
    key: $CI_COMMIT_REF_SLUG
    policy: pull-push
    paths:
      - node_modules/
      - package-lock.json

  build:
    before_script:
      - cd webserver
    script:
      - "node --version"
      - npm i
    cache:
      <<: *global_cache
      policy: push
    tags:
      - local_runner

  deploy:
    before_script:
      - cd webserver
    script:
      - "pm2 start ecosystem.config.js"
    cache:
      <<: *global_cache
      policy: pull
    tags:
      - local_runner
backend:
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - backend-webserver/*
      when: always
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: never
    - if: $CI_COMMIT_TAG
      when: never
  tags: local_runner2
  script:
    - echo backend

  cache: &global_cache
    key: $CI_COMMIT_REF_SLUG
    policy: pull-push
    paths:
      - node_modules/
      - package-lock.json

  build:
    before_script:
      - cd backend-webserver
    script:
      - "node --version"
      - npm i
    cache:
      <<: *global_cache
      policy: push
    tags:
      - local_runner2

  deploy:
    before_script:
      - cd backend-webserver
    script:
      - "pm2 start ecosystem.config.js"
    cache:
      <<: *global_cache
      policy: pull
    tags:
      - local_runner2